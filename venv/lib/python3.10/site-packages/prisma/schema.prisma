generator client {
  provider = "prisma-client-py"
  enable_experimental_decimal = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String      @id @default(cuid())
  googleId           String      @unique                  // Google OAuth ID
  name               String
  email              String      @unique
  avatar             String?                             // Google profile image  id                  String     @id @default(cuid())
  role               UserRole   @default(RECRUITER)
  
  fcm_token           String?
  
  accountType        AccountType @default(LIMITED_ACCESS) // LIMITED_ACCESS | FREE_TRIAL | MONTHLY | YEARLY
  subscriptionActive Boolean     @default(false)
  trialEndsAt        DateTime?                           // only for free_trial users
  registered         Boolean     @default(false)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

   // Relations
  // Add this relation to candidates
  candidates          Candidate[] 
  jobs                Job[]
  applications        Application[]
  interviews          Interview[]
  activities          Activity[]
  companies           Company[]
  userSettings        UserSettings? 

  

  @@map("users")
}


model Activity {
  id          String   @id @default(cuid())
  type        String   // APPLICATION_RECEIVED, INTERVIEW_SCHEDULED, CANDIDATE_HIRED, JOB_CREATED, etc.
  title       String
  description String
  userId      String
  entityId    String?  // ID of the related entity (job, candidate, application, etc.)
  entityType  String?  // Type of entity (job, candidate, application, etc.)
  metadata    Json?    // Additional data as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("Activity")
}



model UserSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // General Settings
  language                  String   @default("en-US")
  timezone                  String   @default("UTC")
  dateFormat                String   @default("MM/DD/YYYY")
  autoSave                  Boolean  @default(true)
  
  // Email Settings
  emailDailyDigest          Boolean  @default(true)
  emailNewCandidateAlerts   Boolean  @default(true)
  emailMarketingEmails      Boolean  @default(false)
  
  // Notification Settings
  emailNewApplications      Boolean  @default(true)
  pushNewApplications       Boolean  @default(true)
  emailInterviewReminders   Boolean  @default(true)
  pushInterviewReminders    Boolean  @default(true)
  emailTaskDeadlines        Boolean  @default(true)
  pushTaskDeadlines         Boolean  @default(false)
  emailProductUpdates       Boolean  @default(true)
  pushProductUpdates        Boolean  @default(false)
  emailSecurityAlerts       Boolean  @default(true)
  pushSecurityAlerts        Boolean  @default(true)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("user_settings")
}

model Company {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  industry              String?
  founded               Int?
  companySize           String?
  website               String?
  email                 String?
  phone                 String?
  taxId                 String?
  logo                  String?
  coverImage            String?
  primaryColor          String   @default("#10b981")
  secondaryColor        String   @default("#3b82f6")
  careerHeadline        String?
  careerDescription     String?
  featuredImages        Json?
  socialMedia           Json?
  remoteWorkPolicy      String?
  remoteHiringRegions   String[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  locations             CompanyLocation[]
  teamMembers           TeamMember[]
  subscription          Subscription?
  paymentMethods        PaymentMethod[]
  billingAddress        BillingAddress?
  invoices              Invoice[]

  @@map("companies")
}

model CompanyLocation {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name            String
  type            String   @default("office")
  address         String
  city            String
  state           String?
  country         String
  zipCode         String?
  phone           String?
  email           String?
  isHeadquarters  Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("company_locations")
}

model TeamMember {
  id          String    @id @default(cuid())
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String
  email       String
  role        String
  department  String
  phone       String?
  avatar      String?
  status      String    @default("active")
  accessLevel String    @default("member")
  invitedAt   DateTime?
  joinedAt    DateTime?
  invitedBy   String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([email, companyId])
  @@map("team_members")
}

model Subscription {
  id                    String   @id @default(cuid())
  companyId             String   @unique
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  planName              String
  planPrice             Decimal  @db.Decimal(10, 2)
  billingCycle          String   @default("monthly")
  status                String   @default("active")
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean  @default(false)
  stripeSubscriptionId  String?
  stripeCustomerId      String?
  teamMemberLimit       Int      @default(25)
  aiCreditsLimit        Int      @default(1000)
  storageLimit          Int      @default(10)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  addons                SubscriptionAddon[]

  @@map("subscriptions")
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  companyId             String
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  type                  String   @default("card")
  last4                 String
  brand                 String
  expiryMonth           Int
  expiryYear            Int
  isDefault             Boolean  @default(false)
  stripePaymentMethodId String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("payment_methods")
}

model BillingAddress {
  id            String   @id @default(cuid())
  companyId     String   @unique
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  contactName   String
  contactEmail  String
  contactPhone  String?
  companyName   String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String?
  zipCode       String
  country       String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("billing_addresses")
}

model Invoice {
  id              String    @id @default(cuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  invoiceNumber   String    @unique
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  status          String    @default("pending")
  dueDate         DateTime
  paidAt          DateTime?
  stripeInvoiceId String?
  downloadUrl     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("invoices")
}

model SubscriptionAddon {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  name           String
  description    String?
  price          Decimal      @db.Decimal(10, 2)
  billingCycle   String       @default("monthly")
  isActive       Boolean      @default(true)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("subscription_addons")
}



model JobSession {
  id                String    @id @default(cuid())
  sessionId         String    @unique
  step              Int       @default(1)
  basicInfo         Json?     // Store step 1 data
  jobDetails        Json?     // Store step 2 data
  requirements      Json?     // Store step 3 data
  publishOptions    Json?     // Store step 4 data
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  
  @@map("job_sessions")
}

enum SalaryPeriod {
  yearly
  monthly
  weekly
  hourly
}

model SkillSuggestion {
  id           String   @id @default(cuid())
  department   String
  suggestions  String[]     // Array of recommended technical skills
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  
  // Relations
  candidates    Candidate[]    @relation("CandidateSkillSuggestions")
  jobs          Job[]          @relation("JobSkillSuggestions")


  @@map("skill_suggestions")
}


model Job {
  id                   String         @id @default(cuid())
  title                String
  department           String
  location             String
  employmentType       EmploymentType
  salaryMin            Int
  salaryMax            Int
  salaryPeriod         SalaryPeriod

  description          String
  responsibilities     String[]
  requirements         String[]       // ✅ Added field
  experience           String?
  teamSize             String?
  reportingStructure   String?

  skills               String[]
  education            String?
  certifications       String[]
  languages            Json
  softSkills           String[]

  isRemote             Boolean        @default(false)
  isHybrid             Boolean        @default(false)

  internalJobBoard     Boolean        @default(false)
  externalJobBoards    Boolean        @default(true)
  socialMedia          Boolean        @default(false)

  applicationFormFields Json?

  status               JobStatus      @default(DRAFT)
  publishedAt          DateTime?
  closedAt             DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  userId               String
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillSuggestions     SkillSuggestion[] @relation("JobSkillSuggestions")
  applications         Application[]
  interviews           Interview[]
  
  @@map("jobs")
}

model Candidate {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  phone             String?

  address           String[]
  location          String?

  personalInfo      Json?
  summary           String?

  education         Json?
  experience        Json?
  previousJobs      Json?
  internships       String[]
  technicalSkills   String[]
  softSkills        String[]
  languages         Json?
  certifications    Json?
  projects          Json?
  hobbies           String[]

  salaryExpectation Int?
  department        String?

  applicationStatus ApplicationStatus  @default(NEW)
  interviewStatus   InterviewStatus @default(NOT_SCHEDULED)
  resume            String?
  portfolio         String?
  linkedin          String?
  github            String?

  userId            String?
  user              User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  applications      Application[]
  interviews        Interview[]
  skillSuggestions  SkillSuggestion[] @relation("CandidateSkillSuggestions")

  @@map("candidates")
}



model Application {
  id           String            @id @default(cuid())
  jobId        String
  candidateId  String
  coverLetter  String?
  status       ApplicationStatus @default(INVITED)
  matchScore   Int?
  notes        String?
  
  joinToken       String?       // Token for joining the interview
  tokenExpiry     DateTime?     // Token expiration datetime

  appliedAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // Relations
  job          Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate    Candidate         @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  interviews   Interview[]

  interviewResult InterviewResult? @relation("ApplicationToResult")

  @@unique([jobId, candidateId])
  @@map("applications")
}


model Interview {
  id            String          @id @default(cuid())
  candidateId   String
  applicationId String
  scheduledById String
  jobId         String
  
  // Interview Details
  type          InterviewType
  status        InterviewStatus @default(SCHEDULED)
  scheduledAt   DateTime
  duration      Int             @default(60) // minutes
  timezone      String          @default("UTC")
  
  // Meeting Details
  meetingLink   String?
  location      String?
  notes         String?
  
  // Interviewers (JSON array)
  interviewers  Json?           // Array of interviewer objects
  
  // Feedback
  feedback      Json?           // Structured feedback object
  rating        Int?            // Overall rating 1-5
  recommendation String?        // HIRE, NO_HIRE, MAYBE

  // Additional Fields
  joinToken       String?       // Token for joining the interview
  tokenExpiry     DateTime?     // Token expiration datetime
  invitationSent  Boolean       @default(false)  // Whether the invitation email was sent

  // Timestamps
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  startedAt      DateTime?
  completedAt   DateTime?

  // Relations
  candidate     Candidate       @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  application   Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  scheduledBy   User            @relation(fields: [scheduledById], references: [id])
  job           Job             @relation(fields: [jobId], references: [id])

  interviewResult InterviewResult?

  chatHistory     ChatHistory[]   @relation("InterviewToChatHistory")
  evaluations     Evaluation[]    @relation("InterviewToEvaluations")     
  @@map("interviews")
}


model InterviewResult {
  id                      String     @id @default(cuid())
  interviewId             String     @unique
  candidateId             String
  applicationId           String     @unique
  jobId                   String
  evaluatedCount          Int
  totalQuestions          Int
  averageFactualAccuracy  Float
  averageCompleteness     Float
  averageRelevance        Float
  averageCoherence        Float
  averageScore            Float
  passStatus              String
  summaryResult           String
  knowledgeLevel          String
  recommendations         String?
  createdAt               DateTime   @default(now())
  updatedAt               DateTime   @updatedAt

  interview               Interview   @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  application             Application @relation("ApplicationToResult", fields: [applicationId], references: [id], onDelete: Cascade)
  
  @@map("interview_results")
}


model ChatHistory {
  id            String       @id @default(cuid())
  interviewId   String       
  candidateId   String?
  applicationId String?
  question      String
  answer        String?
  score         Int?
  level         Int           @default(1)
  createdAt     DateTime      @default(now())

  // Relation
  interview     Interview     @relation("InterviewToChatHistory", fields: [interviewId], references: [id], onDelete: Cascade)

  @@map("chat_history")
}



// ✅ UPDATED: Evaluation model with questionText and answerText fields
model Evaluation {
  id                           String    @id @default(cuid())
  interviewId                  String   
  question                     String    // ✅ NEW: Store question text
  answer                       String    // ✅ NEW: Store answer text
  factualAccuracy              String?
  factualAccuracyExplanation   String?
  completeness                 String?
  completenessExplanation      String?
  relevance                    String?
  relevanceExplanation         String?
  coherence                    String?
  coherenceExplanation         String?
  score                        Float?
  inputTokens                  Int?
  outputTokens                 Int?
  finalEvaluation              String?
  evaluatedAt                  DateTime  @default(now())
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  // Relation
  interview     Interview     @relation("InterviewToEvaluations", fields: [interviewId], references: [id], onDelete: Cascade)
 @@map("evaluations")
}



enum UserRole {
  ADMIN
  RECRUITER
  HIRING_MANAGER
  GUEST
}

enum AccountType {
  LIMITED_ACCESS
  FREE_TRIAL
  MONTHLY
  YEARLY
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ApplicationStatus {
  NEW
  INVITED
  APPLIED
  SCREENING
  INTERVIEW
  OFFER
  HIRED
  REJECTED
}

enum InterviewType {
  PHONE
  VIDEO
  IN_PERSON
  TECHNICAL
  BEHAVIORAL
  PANEL
}

enum InterviewStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NOT_SCHEDULED
  RESCHEDULED
  INVITED
  JOINED
}
